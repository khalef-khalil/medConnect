# MedConnect Messaging API Documentation

This document outlines all the messaging-related endpoints provided by the MedConnect backend API.

## Base URL

All endpoints are relative to the base URL:

```
http://localhost:3001/api/v1
```

## Authentication

All messaging endpoints require authentication via a JWT token in the `Authorization` header:

```
Authorization: Bearer <token>
```

## Endpoints

### 1. Get All Conversations

Retrieves all conversations for the authenticated user.

**Endpoint:** `GET /chats`

**Response:**
```json
{
  "conversations": [
    {
      "conversationId": "string",
      "participants": [
        {
          "userId": "string",
          "name": "string",
          "role": "string"
        }
      ],
      "subject": "string",
      "isEncrypted": true,
      "lastMessage": {
        "messageId": "string",
        "senderId": "string",
        "content": "string",
        "timestamp": "string"
      },
      "createdAt": "string",
      "updatedAt": "string"
    }
  ]
}
```

### 2. Create a New Conversation

Creates a new conversation with the specified participants.

**Endpoint:** `POST /chats`

**Request Body:**
```json
{
  "participants": ["string"],
  "subject": "string",
  "e2eeEnabled": true
}
```

**Notes:**
- `participants` is an array of user IDs. The current authenticated user will be automatically added as a participant if not already included.
- `e2eeEnabled` is optional and defaults to `true` for enabling end-to-end encryption.

**Response:**
```json
{
  "message": "Conversation created successfully",
  "conversation": {
    "conversationId": "string",
    "participants": ["string"],
    "subject": "string",
    "isEncrypted": true,
    "lastMessage": {
      "messageId": "string",
      "senderId": "string",
      "content": "string",
      "timestamp": "string"
    },
    "createdAt": "string",
    "updatedAt": "string"
  }
}
```

### 3. Get Messages for a Conversation

Retrieves all messages for a specific conversation.

**Endpoint:** `GET /chats/:conversationId/messages`

**URL Parameters:**
- `conversationId` - ID of the conversation to retrieve messages from

**Response:**
```json
{
  "messages": [
    {
      "messageId": "string",
      "conversationId": "string",
      "senderId": "string",
      "content": "string",
      "isEncrypted": true,
      "isAIGenerated": false,
      "timestamp": "string",
      "createdAt": "string",
      "read": false
    }
  ],
  "count": 0,
  "isEncrypted": true
}
```

**Notes:**
- When retrieved, encrypted messages are automatically decrypted for the authorized user.
- `isAIGenerated` indicates if the message was generated by the AI assistant.

### 4. Send a Message

Sends a new message in an existing conversation.

**Endpoint:** `POST /chats/:conversationId/messages`

**URL Parameters:**
- `conversationId` - ID of the conversation to send a message to

**Request Body:**
```json
{
  "content": "string",
  "encryptionMetadata": {
    "algorithm": "string",
    "keyId": "string"
  }
}
```

**Notes:**
- `encryptionMetadata` is optional. When not provided, the system uses the established encryption key for the conversation.

**Response:**
```json
{
  "message": "Message sent successfully",
  "messageDetails": {
    "messageId": "string",
    "conversationId": "string",
    "senderId": "string",
    "content": "string",
    "isEncrypted": true,
    "timestamp": "string",
    "createdAt": "string",
    "read": false
  }
}
```

### 5. Mark Messages as Read

Marks specified messages as read.

**Endpoint:** `PUT /chats/:conversationId/read`

**URL Parameters:**
- `conversationId` - ID of the conversation containing the messages

**Request Body:**
```json
{
  "messageIds": ["string"]
}
```

**Response:**
```json
{
  "message": "Messages marked as read",
  "messageIds": ["string"]
}
```

### 6. Get AI Response

Sends a message to the AI assistant and receives a response.

**Endpoint:** `POST /chats/:conversationId/ai-response`

**URL Parameters:**
- `conversationId` - ID of the conversation to send the AI message to

**Request Body:**
```json
{
  "message": "string",
  "context": {
    "key": "value"
  }
}
```

**Notes:**
- `context` is optional and can be used to provide additional context to the AI assistant.

**Response:**
```json
{
  "message": "AI response generated successfully",
  "messageDetails": {
    "messageId": "string",
    "conversationId": "string",
    "senderId": "AI_ASSISTANT",
    "content": "string",
    "intent": "string",
    "intentConfidence": 0.0,
    "intentCategory": "string",
    "intentPriority": "string",
    "isAIGenerated": true,
    "isEncrypted": true,
    "timestamp": "string",
    "createdAt": "string",
    "parameters": {},
    "read": false
  }
}
```

**Notes:**
- The AI assistant uses Google's Dialogflow to detect intents and generate responses.
- `intentCategory` can be one of: "MEDICAL", "ADMINISTRATIVE", or "GENERAL"
- `intentPriority` can be one of: "HIGH", "MEDIUM", or "LOW"
- High priority medical intents trigger notifications to doctors.

## Data Models

### Message

```json
{
  "messageId": "string",
  "conversationId": "string",
  "senderId": "string",
  "participantIds": ["string"],
  "content": "string",
  "isEncrypted": true,
  "isAIGenerated": false,
  "originalLength": 0,
  "timestamp": 0,
  "createdAt": "string",
  "read": false,
  "metadata": {
    "intent": "string",
    "intentConfidence": 0.0,
    "intentCategory": "string",
    "intentPriority": "string",
    "requiresFollowUp": false,
    "parameters": "string",
    "hasParameters": true
  }
}
```

### Conversation

```json
{
  "conversationId": "string",
  "participants": [
    {
      "userId": "string",
      "name": "string",
      "role": "string"
    }
  ],
  "subject": "string",
  "isEncrypted": true,
  "lastMessage": {
    "messageId": "string",
    "senderId": "string",
    "content": "string",
    "timestamp": "string"
  },
  "createdAt": "string",
  "updatedAt": "string"
}
```

## Security

- All messages are encrypted using AES-256-CBC encryption.
- Each conversation has its own unique encryption key.
- Encryption keys are managed by the `encryption-key.service`.
- Messages are automatically decrypted when retrieved by an authorized participant. 